<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Normal Prices Registry</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .header p {
            margin: 0;
            color: #7f8c8d;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .controls-row {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: end;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .load-button, .sync-button, .download-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .sync-button { background-color: #27ae60; }
        .download-button { background-color: #8e44ad; }
        
        .load-button:hover { background-color: #2980b9; }
        .sync-button:hover { background-color: #1e8449; }
        .download-button:hover { background-color: #7d3c98; }
        
        .load-button:disabled, .sync-button:disabled, .download-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .status-bar {
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            white-space: nowrap;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .error {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .pagination {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 12px;
        }
        
        .pagination button {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button:disabled {
            color: #aaa;
            cursor: not-allowed;
            background: #f6f6f6;
        }
        
        .price-input {
            width: 120px;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .row-dirty {
            background-color: #fffbea;
        }
        
        .cell-error {
            outline: 2px solid #e74c3c;
            background: #fdecea;
        }
        
        .thumb {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .thumb:hover {
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 4px;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #000;
        }

        /* GitHub Setup Styles */
        .github-setup {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .github-setup h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }

        .setup-instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .setup-instructions code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        .github-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .github-inputs input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .github-connect-btn {
            background-color: #24292e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .github-connect-btn:hover {
            background-color: #1a1e22;
        }

        .github-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
        }

        .github-status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .disconnect-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .disconnect-button:hover {
            background-color: #c82333;
        }

        .sync-info {
            color: #6c757d;
            font-size: 12px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>Normal Prices Registry</h1>
        <p>Display and browse data files (CSV or Excel .xlsx) with GitHub sync</p>
        <div id="githubStatus" class="github-status" style="display: none;">
            <span id="connectionStatus"></span>
        </div>
    </div>

    <!-- GitHub Setup Section -->
    <div id="githubSetup" class="github-setup">
        <h3>🔧 GitHub Configuration</h3>
        <div class="setup-instructions">
            <p><strong>Quick Setup:</strong> Create a GitHub Personal Access Token with <code>repo</code> scope and enter it below. We'll automatically use your current repository.</p>
        </div>
        <div class="github-inputs">
            <input type="password" id="githubToken" placeholder="Personal Access Token (ghp_...)" style="flex: 1;" />
            <button id="connectGitHub" class="github-connect-btn">Connect to GitHub</button>
        </div>
        <div id="githubSetupStatus" class="status-message" style="display: none;"></div>
    </div>
    
    <div class="controls" id="mainControls" style="display: none;">
        <div class="controls-row">
            <input id="searchInput" class="search-input" type="search" placeholder="Search Product ID, Brand, Product Name, Category" />
            <button id="loadButton" class="load-button">Load Data</button>
            <button id="syncButton" class="sync-button" disabled>Sync to GitHub</button>
            <button id="disconnectButton" class="disconnect-button">Disconnect</button>
        </div>
        <div class="status-bar">
            <span id="statusText">No data loaded.</span>
            <span id="dirtyText"></span>
            <span id="syncInfo"></span>
        </div>
    </div>
    
    <div id="errorMessage"></div>
    <div id="dataContainer">
        <div class="empty-state">
            Click "Load Data" to display the contents.
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <img id="modalImage" class="modal-image" src="" alt="Preview">
        </div>
    </div>

    <script>
        // Defaults
        const DEFAULT_FILE = 'data/products.xlsx';
        
        // UI elements
        const loadButton = document.getElementById('loadButton');
        const syncButton = document.getElementById('syncButton');
        const searchInput = document.getElementById('searchInput');
        const errorMessage = document.getElementById('errorMessage');
        const dataContainer = document.getElementById('dataContainer');
        const statusText = document.getElementById('statusText');
        const dirtyText = document.getElementById('dirtyText');
        const syncInfo = document.getElementById('syncInfo');

        // GitHub configuration
        let githubConfig = {
            username: '',
            repo: '',
            token: '',
            branch: 'main'
        };

        // App state
        const pageSize = 100; // first 100 rows by default
        let workbookRef = null; // original workbook
        let sheetNameRef = null;
        let headersRef = [];
        let allRows = []; // array of objects keyed by headers
        let filteredRows = [];
        let currentPage = 1;
        let dirtyById = new Map(); // id -> numeric price string
        let errorById = new Set(); // rows with validation errors
        let lastCommitSha = null;
        let lastSyncTime = null;

        // Debounced search
        let searchTimer = null;
        searchInput.addEventListener('input', () => {
            if (!allRows.length) return;
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                applySearch(searchInput.value.trim());
                currentPage = 1;
                render();
            }, 200);
        });
        
        // Load button click handler
        loadButton.addEventListener('click', async function() {
            if (githubConfig.token) {
                await loadDataFromGitHub();
            } else {
                loadData(DEFAULT_FILE);
            }
        });

        // GitHub connection handler
        document.getElementById('connectGitHub').addEventListener('click', connectToGitHub);

        // Disconnect button handler
        document.getElementById('disconnectButton').addEventListener('click', disconnectFromGitHub);

        // Sync button handler
        syncButton.addEventListener('click', async () => {
            if (errorById.size > 0) {
                alert('Please fix validation errors before syncing.');
                return;
            }
            if (dirtyById.size === 0) {
                alert('No changes to sync.');
                return;
            }
            try {
                await syncToGitHub();
            } catch (e) {
                console.error('Sync failed:', e);
                showStatus('githubSetupStatus', `Sync failed: ${e.message}`, 'error');
            }
        });
        
        // Decide loader based on file extension
        function loadData(filePath) {
            console.log('Loading data from local file:', filePath);
            if (filePath.toLowerCase().endsWith('.csv')) {
                loadCSV(filePath);
            } else if (filePath.toLowerCase().endsWith('.xlsx')) {
                loadXLSX(filePath);
            } else {
                console.error('Unsupported file type:', filePath);
                errorMessage.innerHTML = `<div class="error">Unsupported file type. Please select a .csv or .xlsx file.</div>`;
            }
        }

        // CSV loading and parsing function (kept for completeness)
        async function loadCSV(filePath) {
            try {
                dataContainer.innerHTML = '<div class="loading">Loading data...</div>';
                errorMessage.innerHTML = '';
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`Failed to load file: ${response.status} ${response.statusText}`);
                }
                const csvText = await response.text();
                const data = parseCSV(csvText);
                headersRef = data.headers;
                allRows = data.rows.map((row, idx) => rowToObject(headersRef, row, idx));
                filteredRows = allRows;
                workbookRef = null;
                sheetNameRef = null;
                dirtyById.clear();
                errorById.clear();
                currentPage = 1;
                syncButton.disabled = false; // will fallback to download later
                statusText.textContent = `Loaded ${allRows.length} rows`;
                render();
            } catch (error) {
                console.error('Error loading CSV:', error);
                errorMessage.innerHTML = `<div class="error">Error loading file: ${error.message}</div>`;
                dataContainer.innerHTML = '<div class="empty-state">Failed to load data.</div>';
            }
        }

        // XLSX loading and parsing function
        async function loadXLSX(filePath) {
            try {
                console.log('Starting XLSX load for:', filePath);
                dataContainer.innerHTML = '<div class="loading">Loading data...</div>';
                errorMessage.innerHTML = '';

                console.log('Fetching file from:', filePath);
                const response = await fetch(filePath);
                console.log('Local file fetch response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Failed to load file: ${response.status} ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });

                const firstSheetName = workbook.SheetNames[0];
                const firstSheet = workbook.Sheets[firstSheetName];

                const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, blankrows: false });
                if (!rows || rows.length === 0) {
                    headersRef = [];
                    allRows = [];
                    filteredRows = [];
                    displayEmpty();
                    return;
                }

                const headers = rows[0].map(h => String(h ?? '').trim());
                const dataRows = rows.slice(1).map(r => headers.map((_, idx) => String((r[idx] ?? '')).trim()));

                headersRef = headers;
                allRows = dataRows.map((row, idx) => rowToObject(headersRef, row, idx));
                filteredRows = allRows;
                workbookRef = workbook;
                sheetNameRef = firstSheetName;
                dirtyById.clear();
                errorById.clear();
                currentPage = 1;
                syncButton.disabled = false; // will attempt FS API later
                statusText.textContent = `Loaded ${allRows.length} rows`;
                render();
            } catch (error) {
                console.error('Error loading XLSX:', error);
                errorMessage.innerHTML = `<div class="error">Error loading file: ${error.message}</div>`;
                dataContainer.innerHTML = '<div class="empty-state">Failed to load data.</div>';
            }
        }
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) {
                return { headers: [], rows: [] };
            }
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = lines.slice(1).map(line => line.split(',').map(cell => cell.trim()));
            return { headers, rows };
        }

        function rowToObject(headers, row, idx) {
            const obj = {};
            headers.forEach((h, i) => { obj[h] = row[i] ?? ''; });
            obj.__rowIndex = idx;
            obj.__id = obj.product_id && obj.product_id !== '' ? String(obj.product_id) : `row_${idx}`;
            return obj;
        }

        function applySearch(query) {
            if (!query) {
                filteredRows = allRows;
                return;
            }
            const q = query.toLowerCase();
            const fields = ['Product ID', 'Brand', 'Product', 'Category'];
            filteredRows = allRows.filter(r => fields.some(f => String(r[f] ?? '').toLowerCase().includes(q)));
        }

        function render() {
            if (!filteredRows.length) {
                displayEmpty();
                return;
            }
            const total = filteredRows.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            const start = (currentPage - 1) * pageSize;
            const pageRows = filteredRows.slice(start, start + pageSize);

            dataContainer.innerHTML = buildTable(headersRef, pageRows) + buildPagination(total, currentPage, totalPages);
            updateDirtyStatus();
        }

        function buildTable(headers, rows) {
            // Build headers with competitor_price as extra column
            const safeHeaders = headers.slice();
            const thead = `
                <thead>
                    <tr>
                        ${safeHeaders.map(h => `<th>${escapeHtml(h)}</th>`).join('')}
                        <th>competitor_price</th>
                    </tr>
                </thead>`;
            const tbodyRows = rows.map(r => {
                const rowId = r.__id;
                const isDirty = dirtyById.has(rowId);
                const priceVal = dirtyById.get(rowId) ?? '';
                const rowClass = isDirty ? ' class="row-dirty"' : '';
                const cells = safeHeaders.map(h => `<td>${renderCell(h, r[h])}</td>`).join('');
                const priceInputClass = errorById.has(rowId) ? 'price-input cell-error' : 'price-input';
                const priceCell = `<td><input type="text" inputmode="decimal" pattern="[0-9]*" class="${priceInputClass}" data-rowid="${escapeHtml(rowId)}" value="${escapeAttr(priceVal)}" placeholder="0.00" /></td>`;
                return `<tr${rowClass}>${cells}${priceCell}</tr>`;
            }).join('');
            return `
                <div class="table-container">
                    <table>
                        ${thead}
                        <tbody>
                            ${tbodyRows}
                        </tbody>
                    </table>
                </div>`;
        }

        function renderCell(header, value) {
            const headerLc = String(header || '').toLowerCase();
            const text = String(value ?? '');
            
            // Handle image columns (url, image, img, etc.)
            if ((headerLc.includes('url') || headerLc.includes('URL') || headerLc.includes('Image')) && text) {
                // Check if it's a valid URL
                if (isValidUrl(text)) {
                    const safeUrl = escapeAttr(text);
                    return `<img src="${safeUrl}" class="thumb" onclick="openModal('${safeUrl}')" onerror="this.onerror=null; this.replaceWith(Object.assign(document.createElement('a'), {href: '${safeUrl}', target: '_blank', rel: 'noopener noreferrer', textContent: 'link'}));" />`;
                }
                // If it's not a URL but contains image-related content, try to extract URL
                const urlMatch = text.match(/https?:\/\/[^\s]+/i);
                if (urlMatch) {
                    const safeUrl = escapeAttr(urlMatch[0]);
                    return `<img src="${safeUrl}" class="thumb" onclick="openModal('${safeUrl}')" onerror="this.onerror=null; this.replaceWith(Object.assign(document.createElement('a'), {href: '${safeUrl}', target: '_blank', rel: 'noopener noreferrer', textContent: 'link'}));" />`;
                }
            }
            return escapeHtml(text);
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function buildPagination(total, page, totalPages) {
            return `
                <div class="pagination">
                    <span>${total} rows • Page ${page} of ${totalPages}</span>
                    <button ${page <= 1 ? 'disabled' : ''} id="prevPage">Prev</button>
                    <button ${page >= totalPages ? 'disabled' : ''} id="nextPage">Next</button>
                </div>`;
        }

        function updateDirtyStatus() {
            const dirtyCount = dirtyById.size;
            dirtyText.textContent = dirtyCount ? ` • ${dirtyCount} edited` : '';
            updateSyncDisplay();
            // Bind events for price inputs and pagination buttons
            document.querySelectorAll('input.price-input').forEach(input => {
                input.addEventListener('input', onPriceInputChange);
                input.addEventListener('blur', onPriceInputBlur);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') { e.currentTarget.blur(); }
                });
            });
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            if (prevBtn) prevBtn.addEventListener('click', () => { currentPage = Math.max(1, currentPage - 1); render(); });
            if (nextBtn) nextBtn.addEventListener('click', () => { currentPage += 1; render(); });
        }

        function onPriceInputChange(e) {
            const input = e.currentTarget;
            const rowId = input.getAttribute('data-rowid');
            let val = input.value;
            // validation: only numbers (allow one dot), non-negative
            val = val.replace(/,/g, '.');
            if (!/^\d*(?:\.\d{0,2})?$/.test(val)) {
                errorById.add(rowId);
                input.classList.add('cell-error');
            } else {
                input.classList.remove('cell-error');
                errorById.delete(rowId);
                if (val === '') {
                    dirtyById.delete(rowId);
                } else {
                    dirtyById.set(rowId, val);
                }
            }
            // mark row dirty state visually
            const tr = input.closest('tr');
            if (tr) {
                if (dirtyById.has(rowId)) tr.classList.add('row-dirty'); else tr.classList.remove('row-dirty');
            }
            dirtyText.textContent = dirtyById.size ? ` • ${dirtyById.size} edited` : '';
            syncButton.disabled = errorById.size > 0;
        }

        function onPriceInputBlur(e) {
            const input = e.currentTarget;
            const rowId = input.getAttribute('data-rowid');
            let val = input.value.replace(/,/g, '.');
            if (val && /^\d+(?:\.\d+)?$/.test(val)) {
                // normalize to at most 2 decimals
                const num = Number(val);
                input.value = Number.isFinite(num) ? num.toFixed(2) : val;
                dirtyById.set(rowId, input.value);
            }
        }
        
        // GitHub API functions
        async function connectToGitHub() {
            const token = document.getElementById('githubToken').value.trim();

            if (!token) {
                showStatus('githubSetupStatus', 'Please enter your GitHub Personal Access Token', 'error');
                return;
            }

            showStatus('githubSetupStatus', '🔄 Connecting to GitHub...', 'info');
            console.log('Starting GitHub connection...');

            try {
                // Auto-detect current repository from page URL
                const currentUrl = window.location.href;
                console.log('Current URL:', currentUrl);
                
                // Extract username and repo from GitHub Pages URL
                let username, repo;
                if (currentUrl.includes('.github.io')) {
                    const match = currentUrl.match(/https?:\/\/([^.]+)\.github\.io/);
                    if (match) {
                        username = match[1];
                        repo = `${username}.github.io`;
                        console.log('Detected GitHub Pages repo:', { username, repo });
                    }
                }
                
                // Fallback: get authenticated user info
                if (!username) {
                    console.log('Getting user info from GitHub API...');
                    const userResponse = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        username = userData.login;
                        repo = `${username}.github.io`;
                        console.log('Got user from API:', { username, repo });
                    } else {
                        throw new Error('Invalid GitHub token or insufficient permissions');
                    }
                }

                githubConfig = { username, repo, token, branch: 'main' };
                console.log('GitHub config set:', { username, repo, branch: 'main' });

                // Test connection by getting repo info
                console.log('Testing repository connection...');
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                console.log('Repository check response status:', response.status);

                if (response.status === 404) {
                    console.log('Repository not found, attempting to create...');
                    await createRepository();
                } else if (response.ok) {
                    const repoData = await response.json();
                    console.log('Repository found:', repoData.name);
                    
                    // Save config
                    localStorage.setItem('githubConfig', JSON.stringify({ username, repo }));
                    
                    // Show main app
                    document.getElementById('githubSetup').style.display = 'none';
                    document.getElementById('mainControls').style.display = 'block';
                    document.getElementById('githubStatus').style.display = 'block';
                    document.getElementById('connectionStatus').innerHTML = `✅ Connected to ${username}/${repo}`;
                    document.getElementById('githubStatus').className = 'github-status connected';
                    
                    showStatus('githubSetupStatus', '✅ Connected! You can now load and sync data.', 'success');
                    console.log('Successfully connected to GitHub');
                } else {
                    const errorData = await response.json();
                    console.error('Repository check failed:', errorData);
                    throw new Error('Failed to connect to repository: ' + (errorData.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('GitHub connection error:', error);
                showStatus('githubSetupStatus', `❌ Error: ${error.message}`, 'error');
            }
        }

        async function createRepository() {
            showStatus('githubSetupStatus', '🔄 Creating repository...', 'info');
            console.log('Creating repository:', githubConfig.repo);
            
            const response = await fetch('https://api.github.com/user/repos', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: githubConfig.repo,
                    description: 'Product prices data storage',
                    private: false,
                    auto_init: true
                })
            });

            console.log('Create repository response status:', response.status);

            if (response.ok) {
                const repoData = await response.json();
                console.log('Repository created:', repoData.name);
                
                localStorage.setItem('githubConfig', JSON.stringify({ 
                    username: githubConfig.username, 
                    repo: githubConfig.repo 
                }));
                
                document.getElementById('githubSetup').style.display = 'none';
                document.getElementById('mainControls').style.display = 'block';
                document.getElementById('githubStatus').style.display = 'block';
                document.getElementById('connectionStatus').innerHTML = `✅ Connected to ${githubConfig.username}/${githubConfig.repo}`;
                document.getElementById('githubStatus').className = 'github-status connected';
                
                showStatus('githubSetupStatus', '✅ Repository created and connected!', 'success');
                console.log('Repository creation successful');
            } else {
                const errorData = await response.json();
                console.error('Repository creation failed:', errorData);
                throw new Error('Failed to create repository: ' + (errorData.message || 'Unknown error'));
            }
        }

        async function loadDataFromGitHub() {
            if (!githubConfig.token) {
                console.error('No GitHub token available');
                throw new Error('Not connected to GitHub');
            }

            console.log('Loading data from GitHub...', {
                username: githubConfig.username,
                repo: githubConfig.repo,
                file: DEFAULT_FILE
            });

            showStatus('githubSetupStatus', '🔄 Loading data from GitHub...', 'info');

            try {
                const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${DEFAULT_FILE}`;
                console.log('Fetching from URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                console.log('GitHub fetch response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('GitHub file data received:', {
                        name: data.name,
                        size: data.size,
                        sha: data.sha
                    });
                    
                    lastCommitSha = data.sha;
                    
                    // Decode base64 content
                    console.log('Decoding base64 content...');
                    console.log('Raw base64 content (first 100 chars):', data.content.substring(0, 100));
                    
                    // GitHub API returns base64 content with newlines, need to clean it
                    const cleanBase64 = data.content.replace(/\s/g, '');
                    console.log('Cleaned base64 length:', cleanBase64.length);
                    
                    const content = atob(cleanBase64);
                    console.log('Decoded content length:', content.length);
                    
                    if (content.length === 0) {
                        throw new Error('Decoded content is empty - file may be corrupted');
                    }
                    
                    const arrayBuffer = Uint8Array.from(content, c => c.charCodeAt(0)).buffer;
                    console.log('Array buffer created, size:', arrayBuffer.byteLength);
                    
                    // Parse Excel file
                    console.log('Parsing Excel file...');
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    console.log('Workbook sheets:', workbook.SheetNames);
                    
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('No sheets found in the Excel file');
                    }
                    
                    const firstSheetName = workbook.SheetNames[0];
                    console.log('Using sheet:', firstSheetName);
                    const firstSheet = workbook.Sheets[firstSheetName];
                    
                    if (!firstSheet) {
                        throw new Error('First sheet is empty or invalid');
                    }
                    
                    console.log('Sheet range:', firstSheet['!ref']);
                    
                    // Try multiple parsing approaches
                    let rows;
                    try {
                        rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, blankrows: false });
                        console.log('Method 1 - Parsed rows count:', rows.length);
                    } catch (e) {
                        console.log('Method 1 failed, trying alternative parsing...');
                        rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: true, defval: '' });
                        console.log('Method 2 - Parsed rows count:', rows.length);
                    }
                    
                    console.log('First few rows:', rows.slice(0, 3));
                    
                    if (!rows || rows.length === 0) {
                        console.log('No data found in Excel file');
                        headersRef = [];
                        allRows = [];
                        filteredRows = [];
                        displayEmpty();
                        return;
                    }

                    const headers = rows[0].map(h => String(h ?? '').trim());
                    const dataRows = rows.slice(1).map(r => headers.map((_, idx) => String((r[idx] ?? '')).trim()));
                    console.log('Headers:', headers);
                    console.log('Data rows count:', dataRows.length);

                    headersRef = headers;
                    allRows = dataRows.map((row, idx) => rowToObject(headersRef, row, idx));
                    filteredRows = allRows;
                    workbookRef = workbook;
                    sheetNameRef = firstSheetName;
                    dirtyById.clear();
                    errorById.clear();
                    currentPage = 1;
                    syncButton.disabled = false;
                    statusText.textContent = `Loaded ${allRows.length} rows from GitHub`;
                    console.log('Calling render()...');
                    render();
                    
                    showStatus('githubSetupStatus', '✅ Data loaded from GitHub', 'success');
                    console.log('GitHub data loading completed successfully');
                } else if (response.status === 404) {
                    console.log('File not found on GitHub, loading local file...');
                    // File doesn't exist yet, load local file
                    loadData(DEFAULT_FILE);
                } else {
                    const errorData = await response.text();
                    console.error('GitHub load failed:', response.status, errorData);
                    throw new Error(`Failed to load data from GitHub (${response.status}): ${errorData}`);
                }
            } catch (error) {
                console.error('GitHub load error:', error);
                showStatus('githubSetupStatus', `❌ Error loading from GitHub: ${error.message}`, 'error');
                // Fallback to local file
                console.log('Falling back to local file...');
                loadData(DEFAULT_FILE);
            }
        }

        async function syncToGitHub() {
            if (!githubConfig.token) {
                throw new Error('Not connected to GitHub');
            }

            showStatus('githubSetupStatus', '🔄 Syncing to GitHub...', 'info');

            try {
                // Check for conflicts by fetching current remote state
                const conflictCheck = await fetch(
                    `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${DEFAULT_FILE}`,
                    {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (conflictCheck.ok) {
                    const remoteData = await conflictCheck.json();
                    if (remoteData.sha !== lastCommitSha) {
                        const message = `⚠️ Conflict detected! The remote file has been modified since you last loaded it.\n\n` +
                                      `Your changes: ${dirtyById.size} rows\n` +
                                      `Remote SHA: ${remoteData.sha.substring(0, 7)}\n` +
                                      `Your SHA: ${lastCommitSha ? lastCommitSha.substring(0, 7) : 'none'}\n\n` +
                                      `Do you want to overwrite the remote changes with your local changes?`;
                        
                        if (!confirm(message)) {
                            showStatus('githubSetupStatus', 'Sync cancelled due to conflict', 'error');
                            return;
                        }
                    }
                }

                // Build updated workbook
                const updatedWb = buildUpdatedWorkbook();
                const buffer = XLSX.write(updatedWb, { type: 'array', bookType: 'xlsx' });
                
                // Convert to base64 (using proper binary string conversion)
                const uint8Array = new Uint8Array(buffer);
                let binaryString = '';
                for (let i = 0; i < uint8Array.length; i++) {
                    binaryString += String.fromCharCode(uint8Array[i]);
                }
                const base64Content = btoa(binaryString);
                console.log('Generated base64 content length:', base64Content.length);
                
                const message = `Update product prices - ${new Date().toLocaleString()}`;
                
                const body = {
                    message: message,
                    content: base64Content,
                    branch: githubConfig.branch
                };
                
                if (lastCommitSha) {
                    body.sha = lastCommitSha;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${DEFAULT_FILE}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    lastCommitSha = data.content.sha;
                    lastSyncTime = new Date().toISOString();
                    localStorage.setItem('lastSyncTime', lastSyncTime);
                    
                    const updatedCount = dirtyById.size;
                    // Clear dirty changes
                    dirtyById.clear();
                    updateSyncDisplay();
                    render();
                    
                    showStatus('githubSetupStatus', `✅ Sync complete! Updated ${updatedCount} rows.`, 'success');
                } else {
                    const error = await response.json();
                    if (response.status === 409) {
                        throw new Error('Conflict: The file was modified by someone else. Please reload and try again.');
                    }
                    throw new Error(error.message || 'Failed to push to GitHub');
                }
            } catch (error) {
                console.error('GitHub sync error:', error);
                throw error;
            }
        }

        function disconnectFromGitHub() {
            if (dirtyById.size > 0) {
                if (!confirm(`You have ${dirtyById.size} unsynced changes. Disconnect anyway?`)) return;
            }
            
            githubConfig = { username: '', repo: '', token: '', branch: 'main' };
            lastCommitSha = null;
            lastSyncTime = null;
            localStorage.removeItem('lastSyncTime');
            
            document.getElementById('githubSetup').style.display = 'block';
            document.getElementById('mainControls').style.display = 'none';
            document.getElementById('githubStatus').style.display = 'none';
            
            showStatus('githubSetupStatus', 'Disconnected from GitHub', 'info');
        }

        function updateSyncDisplay() {
            if (lastSyncTime) {
                const syncDate = new Date(lastSyncTime);
                const now = new Date();
                const diffMs = now - syncDate;
                const diffMins = Math.floor(diffMs / 60000);
                
                let timeStr;
                if (diffMins < 1) {
                    timeStr = 'Just now';
                } else if (diffMins < 60) {
                    timeStr = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                } else {
                    const diffHours = Math.floor(diffMins / 60);
                    if (diffHours < 24) {
                        timeStr = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                    } else {
                        timeStr = syncDate.toLocaleString();
                    }
                }
                
                syncInfo.textContent = ` • Last synced: ${timeStr}`;
            } else {
                syncInfo.textContent = '';
            }
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.innerHTML = message;
            element.className = `status-message ${type}`;
            element.style.display = 'block';
            
            if (type !== 'info' || !message.includes('🔄')) {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize GitHub connection if saved
        document.addEventListener('DOMContentLoaded', () => {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                // Only show if we have saved config - user still needs to enter token
                console.log('Found saved GitHub config:', config);
                showStatus('githubSetupStatus', 'Previous connection found. Enter your token to reconnect.', 'info');
            }

            const savedSyncTime = localStorage.getItem('lastSyncTime');
            if (savedSyncTime) {
                lastSyncTime = savedSyncTime;
                updateSyncDisplay();
            }
        });

        async function attemptSync() {
            // Check if File System Access API is supported
            if (!('showOpenFilePicker' in window)) {
                throw new Error('File System Access API not supported in this browser. Please use Chrome, Edge, or another Chromium-based browser.');
            }

            const updatedWb = buildUpdatedWorkbook();
            const buffer = XLSX.write(updatedWb, { type: 'array', bookType: 'xlsx' });

            try {
                // If we don't have a file handle yet, ask user to select the data/products.xlsx file
                if (!fileHandleRef) {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{ 
                            description: 'Excel Workbook', 
                            accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] } 
                        }],
                        excludeAcceptAllOption: false,
                        multiple: false,
                        suggestedName: 'products.xlsx'
                    });
                    fileHandleRef = handle;
                }

                // Request write permission
                const perm = await fileHandleRef.requestPermission({ mode: 'readwrite' });
                if (perm !== 'granted') {
                    throw new Error('Permission not granted to write the file. Please grant write permission and try again.');
                }

                // Write the updated workbook to the file
                const writable = await fileHandleRef.createWritable();
                await writable.write(buffer);
                await writable.close();
                
                alert(`Sync complete! Updated ${dirtyById.size} rows with competitor prices in the local file.`);
                dirtyById.clear();
                render();
            } catch (err) {
                console.error('Sync failed:', err);
                throw err;
            }
        }

        function buildUpdatedWorkbook() {
            const outHeaders = headersRef.includes('competitor_price') ? headersRef.slice() : headersRef.concat(['competitor_price']);
            const data = allRows.map(r => {
                const price = dirtyById.get(r.__id);
                const obj = {};
                outHeaders.forEach(h => {
                    if (h === 'competitor_price') {
                        obj[h] = price ?? '';
                    } else {
                        obj[h] = r[h] ?? '';
                    }
                });
                return obj;
            });
            const ws = XLSX.utils.json_to_sheet(data, { header: outHeaders });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetNameRef || 'Products');
            return wb;
        }

        
        function displayEmpty() {
            dataContainer.innerHTML = '<div class="empty-state">No data found in the file.</div>';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        function escapeAttr(text) {
            return String(text).replace(/"/g, '&quot;');
        }

        // Modal functions
        function openModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = imageUrl;
            modal.style.display = 'block';
            
            // Close modal when clicking outside the image
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            };
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }
    </script>
</body>
</html>
