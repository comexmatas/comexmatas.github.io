<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner - Smart Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #24292e 0%, #0d1117 100%);
            min-height: 100vh;
            padding: 20px;
            color: #c9d1d9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease-out;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(88, 166, 255, 0.3);
        }

        .github-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #161b22;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #30363d;
            margin-top: 10px;
        }

        .card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            animation: slideUp 0.5s ease-out;
        }

        .card h2 {
            color: #58a6ff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button, .file-label {
            padding: 10px 20px;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #21262d;
            color: #c9d1d9;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover, .file-label:hover {
            background: #30363d;
            border-color: #58a6ff;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #238636;
            border-color: #2ea043;
            color: white;
        }

        .btn-primary:hover {
            background: #2ea043;
        }

        .btn-sync {
            background: linear-gradient(135deg, #1f6feb, #58a6ff);
            border: none;
            color: white;
            font-size: 16px;
            padding: 12px 24px;
        }

        .btn-sync:hover {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
        }

        .btn-danger {
            background: #da3633;
            border-color: #f85149;
            color: white;
        }

        .btn-danger:hover {
            background: #f85149;
        }

        .btn-github {
            background: linear-gradient(135deg, #6e40c9, #4c6ef5);
            border: none;
            color: white;
        }

        .btn-github:hover {
            background: linear-gradient(135deg, #7c4dff, #58a6ff);
        }

        input[type="file"] {
            display: none;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #58a6ff;
            background: #0d1117;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-group input {
            flex: 1;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
            animation: slideUp 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status.success {
            background: #0d2818;
            color: #3fb950;
            border: 1px solid #238636;
        }

        .status.error {
            background: #2d1418;
            color: #f85149;
            border: 1px solid #da3633;
        }

        .status.info {
            background: #0d1e33;
            color: #58a6ff;
            border: 1px solid #1f6feb;
        }

        .status.warning {
            background: #2d2418;
            color: #f0883e;
            border: 1px solid #9e6a03;
        }

        .setup-section {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .setup-section h3 {
            color: #f0883e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setup-step {
            margin: 15px 0;
            padding: 15px;
            background: #0d1117;
            border-radius: 6px;
            border-left: 3px solid #58a6ff;
        }

        .code-block {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #7ee787;
            margin: 10px 0;
            word-break: break-all;
        }

        #scannerContainer {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #30363d;
        }

        #scanner {
            width: 100%;
            height: 480px;
            background: #000;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: #161b22;
            color: #f0883e;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #30363d;
        }

        .data-table td {
            padding: 10px 12px;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }

        .data-table tr {
            background: #0d1117;
            transition: all 0.2s ease;
        }

        .data-table tr:hover {
            background: #161b22;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #58a6ff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #8b949e;
            font-size: 0.9em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .connected-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #0d2818;
            border: 1px solid #238636;
            border-radius: 20px;
            color: #3fb950;
            font-size: 12px;
            font-weight: 600;
        }

        .connected-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #3fb950;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sync-info {
            background: #161b22;
            border-radius: 6px;
            padding: 10px 15px;
            margin-top: 15px;
            font-size: 13px;
            color: #8b949e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .local-changes {
            color: #f0883e;
            font-weight: 600;
        }

        .spinner {
            border: 2px solid #30363d;
            border-top: 2px solid #58a6ff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Barcode Scanner System</h1>
            <div class="github-badge">
                <svg height="20" width="20" viewBox="0 0 16 16" fill="#c9d1d9">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                GitHub-Powered Storage
                <span id="connectionStatus"></span>
            </div>
        </div>

        <!-- GitHub Setup -->
        <div class="card" id="setupCard">
            <h2>🔧 GitHub Configuration</h2>
            
            <div class="setup-section">
                <h3>⚡ Quick Setup Instructions</h3>
                
                <div class="setup-step">
                    <strong>Step 1: Create a GitHub Personal Access Token</strong>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>Go to GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)</li>
                        <li>Click "Generate new token (classic)"</li>
                        <li>Give it a name (e.g., "Barcode Scanner")</li>
                        <li>Select scopes: <code>repo</code> (full control of private repositories)</li>
                        <li>Click "Generate token" and copy it immediately</li>
                    </ol>
                </div>

                <div class="setup-step">
                    <strong>Step 2: Enter Your Configuration</strong>
                    <div style="margin-top: 15px;">
                        <div class="input-group">
                            <input type="text" id="githubUsername" placeholder="GitHub Username (e.g., johndoe)">
                        </div>
                        <div class="input-group">
                            <input type="text" id="githubRepo" placeholder="Repository Name (e.g., barcode-data)">
                        </div>
                        <div class="input-group">
                            <input type="password" id="githubToken" placeholder="Personal Access Token (ghp_...)">
                        </div>
                        <button class="btn-github" onclick="connectToGitHub()">
                            <svg height="16" width="16" viewBox="0 0 16 16" fill="white">
                                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                            </svg>
                            Connect to GitHub
                        </button>
                    </div>
                </div>

                <div class="setup-step">
                    <strong>Step 3: Repository Setup</strong>
                    <p style="margin-top: 10px;">The repository can be public or private. If it doesn't exist, we'll create it for you.</p>
                    <p style="margin-top: 5px;">Your data will be stored as: <code>/data/products.csv</code></p>
                </div>
            </div>

            <div id="setupStatus" class="status" style="display: none;"></div>
        </div>

        <!-- Main App (hidden until connected) -->
        <div id="mainApp" style="display: none;">
            <!-- Database Controls -->
            <div class="card">
                <h2>🔄 Sync Management</h2>
                <div class="button-group">
                    <button class="btn-sync" onclick="smartSync()">
                        <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 2.5a5.5 5.5 0 105.5 5.5.75.75 0 011.5 0 7 7 0 11-3.5-6.06v-.44a.75.75 0 011.5 0v2.25a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h.8A5.48 5.48 0 008 2.5z"/>
                        </svg>
                        Smart Sync
                    </button>
                    
                    <button onclick="downloadLocalBackup()">
                        💾 Download Backup
                    </button>
                    
                    <button class="btn-danger" onclick="clearLocalData()">
                        🗑️ Clear Local Data
                    </button>

                    <button onclick="disconnect()">
                        🔌 Disconnect
                    </button>
                </div>
                
                <div class="sync-info">
                    <div>
                        <span>Last synced: </span>
                        <strong id="lastSyncTime">Never</strong>
                    </div>
                    <div>
                        <span>Local changes: </span>
                        <span class="local-changes" id="localChangesCount">0</span>
                    </div>
                </div>
                
                <div id="dbStatus" class="status" style="display: none;"></div>
                
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalRecords">0</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="uniqueBarcodes">0</div>
                        <div class="stat-label">Unique Barcodes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayScans">0</div>
                        <div class="stat-label">Today's Scans</div>
                    </div>
                </div>
            </div>

            <!-- Barcode Input -->
            <div class="card">
                <h2>📷 Barcode Input</h2>
                <div class="input-group">
                    <input type="text" id="manualBarcode" placeholder="Enter barcode manually...">
                    <button class="btn-primary" onclick="processManualBarcode()">
                        ➕ Add
                    </button>
                </div>
                
                <div class="button-group">
                    <button id="startScanner" onclick="toggleScanner()">
                        📸 Start Camera Scanner
                    </button>
                    <label for="uploadImage" class="file-label">
                        🖼️ Upload Barcode Image
                    </label>
                    <input type="file" id="uploadImage" accept="image/*">
                </div>
                
                <div id="scannerContainer" style="display: none;">
                    <div id="scanner"></div>
                </div>
                
                <div id="scanStatus" class="status" style="display: none;"></div>
            </div>

            <!-- Recent Scans -->
            <div class="card">
                <h2>📋 Recent Scans</h2>
                <div id="recentScansContainer">
                    <div class="empty-state">
                        <p>No scans yet. Start scanning to see data here!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GitHub configuration
        let githubConfig = {
            username: '',
            repo: '',
            token: '',
            branch: 'main'
        };

        // Database state
        let database = [];
        let localChanges = new Set(); // Track which barcodes have local changes
        let scannerActive = false;
        let lastCommitSha = null;
        let lastSyncTime = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved config
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('githubUsername').value = config.username;
                document.getElementById('githubRepo').value = config.repo;
                showStatus('setupStatus', 'Previous configuration found. Enter your token to reconnect.', 'info');
            }

            // Load last sync time
            const savedSyncTime = localStorage.getItem('lastSyncTime');
            if (savedSyncTime) {
                lastSyncTime = savedSyncTime;
                updateSyncDisplay();
            }

            document.getElementById('uploadImage').addEventListener('change', processImage);
            document.getElementById('manualBarcode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') processManualBarcode();
            });
        });

        // GitHub API functions
        async function connectToGitHub() {
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();

            if (!username || !repo || !token) {
                showStatus('setupStatus', 'Please fill in all fields', 'error');
                return;
            }

            githubConfig = { username, repo, token, branch: 'main' };

            showStatus('setupStatus', '🔄 Connecting to GitHub...', 'info');

            try {
                // Test connection by getting repo info
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.status === 404) {
                    // Repo doesn't exist, try to create it
                    await createRepository();
                } else if (response.ok) {
                    // Repo exists
                    localStorage.setItem('githubConfig', JSON.stringify({ username, repo }));
                    
                    // Show main app
                    document.getElementById('setupCard').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('connectionStatus').innerHTML = '<span class="connected-indicator">Connected</span>';
                    
                    showStatus('dbStatus', '✅ Connected! Use Smart Sync to load data.', 'success');
                    
                    // Auto-sync on connect
                    await smartSync();
                } else {
                    throw new Error('Failed to connect to repository');
                }
            } catch (error) {
                showStatus('setupStatus', `❌ Error: ${error.message}`, 'error');
            }
        }

        async function createRepository() {
            showStatus('setupStatus', '🔄 Creating repository...', 'info');
            
            const response = await fetch('https://api.github.com/user/repos', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: githubConfig.repo,
                    description: 'Barcode scanner data storage',
                    private: false,
                    auto_init: true
                })
            });

            if (response.ok) {
                localStorage.setItem('githubConfig', JSON.stringify({ 
                    username: githubConfig.username, 
                    repo: githubConfig.repo 
                }));
                
                document.getElementById('setupCard').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('connectionStatus').innerHTML = '<span class="connected-indicator">Connected</span>';
                
                showStatus('dbStatus', '✅ Repository created and connected!', 'success');
                
                // Initial sync to create file
                await smartSync();
            } else {
                throw new Error('Failed to create repository');
            }
        }

        async function smartSync() {
            showStatus('dbStatus', '🔄 Syncing with GitHub...', 'info');
            
            try {
                // Step 1: Load from GitHub
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/data/products.csv`,
                    {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                let remoteDatabase = [];
                let hasRemoteData = false;

                if (response.ok) {
                    const data = await response.json();
                    lastCommitSha = data.sha;
                    
                    // Decode base64 content
                    const content = atob(data.content);
                    
                    // Parse CSV
                    const parsed = Papa.parse(content, {
                        header: true,
                        dynamicTyping: false,
                        skipEmptyLines: true
                    });
                    
                    remoteDatabase = parsed.data.map(row => ({
                        barcode: String(row.barcode || ''),
                        description: String(row.description || ''),
                        quantity: parseInt(row.quantity) || 0,
                        lastScanned: String(row.lastScanned || ''),
                        firstScanned: String(row.firstScanned || ''),
                        scanCount: parseInt(row.scanCount) || 0,
                        lastSyncedAt: String(row.lastSyncedAt || '')
                    })).filter(item => item.barcode);
                    
                    hasRemoteData = true;
                } else if (response.status === 404) {
                    // File doesn't exist yet
                    hasRemoteData = false;
                } else {
                    throw new Error('Failed to load data');
                }

                // Step 2: Merge databases
                const mergedDatabase = mergeDatabase(database, remoteDatabase);
                
                // Step 3: Check for overwrites and warn
                const overwrites = detectOverwrites(database, remoteDatabase);
                
                if (overwrites.length > 0 && localChanges.size > 0) {
                    const message = `This sync will overwrite ${overwrites.length} remote record(s) with your local changes:\n\n` +
                                  overwrites.slice(0, 5).map(bc => `• ${bc}`).join('\n') +
                                  (overwrites.length > 5 ? `\n... and ${overwrites.length - 5} more` : '') +
                                  '\n\nContinue?';
                    
                    if (!confirm(message)) {
                        showStatus('dbStatus', 'Sync cancelled', 'warning');
                        return;
                    }
                }

                // Step 4: Update local database
                database = mergedDatabase;
                
                // Step 5: Push to GitHub
                await pushToGitHub();
                
                // Step 6: Clear local changes tracking
                localChanges.clear();
                
                // Step 7: Update UI
                updateStats();
                displayRecentScans();
                updateSyncDisplay();
                
                const newRecords = mergedDatabase.length - (hasRemoteData ? remoteDatabase.length : 0);
                showStatus('dbStatus', 
                    `✅ Sync complete! ${database.length} total records${newRecords > 0 ? ` (+${newRecords} new)` : ''}`, 
                    'success'
                );
                
            } catch (error) {
                console.error('Sync error:', error);
                showStatus('dbStatus', `❌ Sync failed: ${error.message}`, 'error');
            }
        }

        function mergeDatabase(local, remote) {
            const merged = new Map();
            const syncTimestamp = new Date().toISOString();
            
            // First, add all remote records
            remote.forEach(item => {
                merged.set(item.barcode, {...item});
            });
            
            // Then, overwrite with local records (local wins)
            local.forEach(item => {
                if (localChanges.has(item.barcode)) {
                    // This is a local change, update sync timestamp
                    merged.set(item.barcode, {
                        ...item,
                        lastSyncedAt: syncTimestamp
                    });
                } else {
                    // Keep existing remote item (no local changes)
                    // Don't overwrite remote
                }
            });
            
            return Array.from(merged.values());
        }

        function detectOverwrites(local, remote) {
            const overwrites = [];
            
            local.forEach(localItem => {
                if (localChanges.has(localItem.barcode)) {
                    const remoteItem = remote.find(r => r.barcode === localItem.barcode);
                    if (remoteItem) {
                        // Check if remote has been modified since our last sync
                        if (remoteItem.lastSyncedAt && lastSyncTime) {
                            const remoteSync = new Date(remoteItem.lastSyncedAt);
                            const ourLastSync = new Date(lastSyncTime);
                            if (remoteSync > ourLastSync) {
                                overwrites.push(localItem.barcode);
                            }
                        }
                    }
                }
            });
            
            return overwrites;
        }

        async function pushToGitHub() {
            // Add sync timestamp to all records
            const syncTimestamp = new Date().toISOString();
            
            // Convert database to CSV
            const csv = Papa.unparse(database);
            const content = btoa(unescape(encodeURIComponent(csv))); // Better encoding for special characters
            
            const message = `Sync at ${new Date().toLocaleString()}`;
            
            const body = {
                message: message,
                content: content,
                branch: githubConfig.branch
            };
            
            if (lastCommitSha) {
                body.sha = lastCommitSha;
            }
            
            const response = await fetch(
                `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/data/products.csv`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                }
            );

            if (response.ok) {
                const data = await response.json();
                lastCommitSha = data.content.sha;
                lastSyncTime = syncTimestamp;
                localStorage.setItem('lastSyncTime', lastSyncTime);
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Failed to push to GitHub');
            }
        }

        function downloadLocalBackup() {
            const csv = Papa.unparse(database);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `barcode_backup_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showStatus('dbStatus', '✅ Backup downloaded', 'success');
        }

        function clearLocalData() {
            if (localChanges.size > 0) {
                if (!confirm(`You have ${localChanges.size} unsynced local changes. Clear anyway?`)) return;
            }
            
            database = [];
            localChanges.clear();
            updateStats();
            displayRecentScans();
            updateSyncDisplay();
            showStatus('dbStatus', 'Local data cleared. Use Smart Sync to reload from GitHub.', 'info');
        }

        function disconnect() {
            if (localChanges.size > 0) {
                if (!confirm(`You have ${localChanges.size} unsynced changes. Disconnect anyway?`)) return;
            }
            
            githubConfig = { username: '', repo: '', token: '', branch: 'main' };
            database = [];
            localChanges.clear();
            lastCommitSha = null;
            lastSyncTime = null;
            localStorage.removeItem('lastSyncTime');
            
            document.getElementById('setupCard').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('connectionStatus').innerHTML = '';
            
            showStatus('setupStatus', 'Disconnected from GitHub', 'info');
        }

        // Barcode processing
        function processBarcode(barcode) {
            const now = new Date().toISOString();
            let existingItem = database.find(item => item.barcode === barcode);
            
            if (existingItem) {
                existingItem.quantity = (existingItem.quantity || 0) + 1;
                existingItem.lastScanned = now;
                existingItem.scanCount = (existingItem.scanCount || 0) + 1;
                localChanges.add(barcode); // Mark as locally modified
                showStatus('scanStatus', 
                    `✅ Barcode ${barcode} updated! Total scans: ${existingItem.scanCount}`, 
                    'info');
            } else {
                const newItem = {
                    barcode: barcode,
                    description: `Item ${barcode}`,
                    quantity: 1,
                    lastScanned: now,
                    firstScanned: now,
                    scanCount: 1,
                    lastSyncedAt: ''
                };
                database.push(newItem);
                localChanges.add(barcode); // Mark as locally added
                showStatus('scanStatus', `✨ New barcode ${barcode} added!`, 'success');
            }
            
            updateStats();
            displayRecentScans();
            updateSyncDisplay();
            
            document.getElementById('manualBarcode').value = '';
        }

        function processManualBarcode() {
            const barcode = document.getElementById('manualBarcode').value.trim();
            if (!barcode) {
                showStatus('scanStatus', 'Please enter a barcode', 'error');
                return;
            }
            processBarcode(barcode);
        }

        // Camera scanner
        function toggleScanner() {
            const container = document.getElementById('scannerContainer');
            const button = document.getElementById('startScanner');
            
            if (!scannerActive) {
                container.style.display = 'block';
                button.textContent = '⏹️ Stop Scanner';
                button.className = 'btn-danger';
                startScanner();
            } else {
                container.style.display = 'none';
                button.textContent = '📸 Start Camera Scanner';
                button.className = '';
                stopScanner();
            }
        }

        function startScanner() {
            scannerActive = true;
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error(err);
                    showStatus('scanStatus', 'Camera error: ' + err, 'error');
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                processBarcode(code);
                
                // Brief pause to prevent duplicate scans
                Quagga.stop();
                setTimeout(() => {
                    if (scannerActive) Quagga.start();
                }, 1000);
            });
        }

        function stopScanner() {
            scannerActive = false;
            Quagga.stop();
        }

        // Image processing
        function processImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                Quagga.decodeSingle({
                    src: e.target.result,
                    numOfWorkers: 0,
                    decoder: {
                        readers: [
                            "code_128_reader",
                            "ean_reader",
                            "ean_8_reader",
                            "code_39_reader",
                            "upc_reader",
                            "upc_e_reader"
                        ]
                    },
                    locate: true
                }, function(result) {
                    if (result && result.codeResult) {
                        processBarcode(result.codeResult.code);
                    } else {
                        showStatus('scanStatus', 'No barcode found in image', 'error');
                    }
                });
            };
            reader.readAsDataURL(file);
        }

        // UI functions
        function updateStats() {
            document.getElementById('totalRecords').textContent = database.length;
            
            const uniqueBarcodes = new Set(database.map(item => item.barcode)).size;
            document.getElementById('uniqueBarcodes').textContent = uniqueBarcodes;
            
            const today = new Date().toISOString().split('T')[0];
            const todayScans = database.filter(item => {
                return item.lastScanned && 
                       typeof item.lastScanned === 'string' && 
                       item.lastScanned.startsWith(today);
            }).length;
            document.getElementById('todayScans').textContent = todayScans;
        }

        function updateSyncDisplay() {
            // Update last sync time
            if (lastSyncTime) {
                const syncDate = new Date(lastSyncTime);
                const now = new Date();
                const diffMs = now - syncDate;
                const diffMins = Math.floor(diffMs / 60000);
                
                let timeStr;
                if (diffMins < 1) {
                    timeStr = 'Just now';
                } else if (diffMins < 60) {
                    timeStr = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                } else {
                    const diffHours = Math.floor(diffMins / 60);
                    if (diffHours < 24) {
                        timeStr = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                    } else {
                        timeStr = syncDate.toLocaleString();
                    }
                }
                
                document.getElementById('lastSyncTime').textContent = timeStr;
            } else {
                document.getElementById('lastSyncTime').textContent = 'Never';
            }
            
            // Update local changes count
            document.getElementById('localChangesCount').textContent = localChanges.size;
            
            // Highlight if changes pending
            const changesElement = document.getElementById('localChangesCount');
            if (localChanges.size > 0) {
                changesElement.style.color = '#f0883e';
                changesElement.style.fontWeight = 'bold';
            } else {
                changesElement.style.color = '#3fb950';
                changesElement.style.fontWeight = 'normal';
            }
        }

        function displayRecentScans() {
            const container = document.getElementById('recentScansContainer');
            
            if (database.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No scans yet. Start scanning to see data here!</p>
                    </div>
                `;
                return;
            }
            
            // Sort by last scanned and show recent 10
            const recent = [...database]
                .sort((a, b) => {
                    const aDate = a.lastScanned || '';
                    const bDate = b.lastScanned || '';
                    return bDate.localeCompare(aDate);
                })
                .slice(0, 10);
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Barcode</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Scan Count</th>
                            <th>Last Scanned</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recent.forEach(item => {
                const date = item.lastScanned ? new Date(item.lastScanned).toLocaleString() : 'Never';
                const isLocal = localChanges.has(item.barcode);
                const statusIcon = isLocal ? '🔸' : '✅';
                const statusText = isLocal ? 'Unsynced' : 'Synced';
                
                html += `
                    <tr>
                        <td><strong>${item.barcode}</strong></td>
                        <td>${item.description}</td>
                        <td>${item.quantity || 0}</td>
                        <td>${item.scanCount || 0}</td>
                        <td>${date}</td>
                        <td>${statusIcon} ${statusText}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.innerHTML = message;
            element.className = `status ${type}`;
            element.style.display = 'flex';
            
            if (type !== 'info' || !message.includes('🔄')) {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // Auto-update sync display every minute
        setInterval(() => {
            updateSyncDisplay();
        }, 60000);

        // Warn before leaving with unsynced changes
        window.addEventListener('beforeunload', (e) => {
            if (localChanges.size > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsynced changes. Are you sure you want to leave?';
            }
        });
    </script>
</body>
</html>
                        lastSyncedAt: syncTimestamp
                    });
                } else if (!merged.has(item.barcode)) {
                    // New local item
                    merged.set(item.barcode, {
                        ...item,
